# ============================================================================
# Tibber 3-Hour Window Automation Examples
# ============================================================================
# Der Sensor "binary_sensor.tibber_is_in_best_3h_window" ist TRUE wÃ¤hrend
# der 3 gÃ¼nstigsten zusammenhÃ¤ngenden Stunden pro Tag.
#
# Dies ist ideal fÃ¼r:
# - E-Auto laden
# - Warmwasserspeicher aufheizen
# - Waschmaschine/Trockner laufen lassen
# - Poolpumpe betreiben
# - Andere energieintensive GerÃ¤te
# ============================================================================

# ----------------------------------------------------------------------------
# Beispiel 1: E-Auto laden wÃ¤hrend billigstem 3h-Fenster
# ----------------------------------------------------------------------------
automation:
  - alias: "Tesla Laden - Beste 3 Stunden"
    description: "Startet Tesla-Laden wÃ¤hrend der 3 gÃ¼nstigsten zusammenhÃ¤ngenden Stunden"

    trigger:
      # Trigger wenn das 3h-Fenster beginnt
      - platform: state
        entity_id: binary_sensor.tibber_is_in_best_3h_window
        from: "off"
        to: "on"

    condition:
      # Nur laden wenn Auto zuhause und Batterie unter 80%
      - condition: state
        entity_id: device_tracker.tesla
        state: "home"
      - condition: numeric_state
        entity_id: sensor.tesla_battery_level
        below: 80

    action:
      # Tesla-Laden starten
      - service: switch.turn_on
        target:
          entity_id: switch.tesla_charger

      # Benachrichtigung senden
      - service: notify.mobile_app
        data:
          title: "ðŸ”Œ Tesla Laden gestartet"
          message: >
            Laden wÃ¤hrend gÃ¼nstigstem 3h-Fenster.
            Durchschnittspreis: {{ state_attr('binary_sensor.tibber_is_in_best_3h_window', 'window_average_price') }}â‚¬/kWh
            Ersparnis: {{ state_attr('binary_sensor.tibber_is_in_best_3h_window', 'savings_percent') }}%

  - alias: "Tesla Laden - Stoppen nach Fenster"
    description: "Stoppt Tesla-Laden wenn 3h-Fenster endet"

    trigger:
      - platform: state
        entity_id: binary_sensor.tibber_is_in_best_3h_window
        from: "on"
        to: "off"

    action:
      - service: switch.turn_off
        target:
          entity_id: switch.tesla_charger

      - service: notify.mobile_app
        data:
          title: "â¸ï¸ Tesla Laden gestoppt"
          message: "3-Stunden-Fenster ist vorbei."

# ----------------------------------------------------------------------------
# Beispiel 2: Warmwasserspeicher aufheizen
# ----------------------------------------------------------------------------
automation:
  - alias: "Warmwasser - Aufheizen billigstes 3h-Fenster"
    description: "Heizt Warmwasserspeicher wÃ¤hrend gÃ¼nstigstem Zeitfenster auf"

    trigger:
      - platform: state
        entity_id: binary_sensor.tibber_is_in_best_3h_window
        to: "on"

    condition:
      # Nur wenn Wassertemperatur unter 55Â°C
      - condition: numeric_state
        entity_id: sensor.water_heater_temperature
        below: 55

    action:
      # Heizung auf Maximum
      - service: water_heater.set_temperature
        target:
          entity_id: water_heater.storage_tank
        data:
          temperature: 70

      # Boost-Modus aktivieren
      - service: switch.turn_on
        target:
          entity_id: switch.water_heater_boost

  - alias: "Warmwasser - Boost deaktivieren"
    description: "Deaktiviert Boost-Modus nach 3h-Fenster"

    trigger:
      - platform: state
        entity_id: binary_sensor.tibber_is_in_best_3h_window
        to: "off"

    action:
      - service: switch.turn_off
        target:
          entity_id: switch.water_heater_boost

# ----------------------------------------------------------------------------
# Beispiel 3: Poolpumpe laufen lassen
# ----------------------------------------------------------------------------
automation:
  - alias: "Pool - Pumpe wÃ¤hrend gÃ¼nstigstem Fenster"
    description: "Betreibt Poolpumpe 3h wÃ¤hrend billigstem Zeitfenster"

    trigger:
      - platform: state
        entity_id: binary_sensor.tibber_is_in_best_3h_window
        to: "on"

    condition:
      # Nur im Sommer (Mai-September)
      - condition: template
        value_template: "{{ now().month >= 5 and now().month <= 9 }}"

    action:
      - service: switch.turn_on
        target:
          entity_id: switch.pool_pump

      - service: notify.mobile_app
        data:
          title: "ðŸŠ Poolpumpe gestartet"
          message: "LÃ¤uft wÃ¤hrend gÃ¼nstigstem 3h-Fenster ({{ state_attr('binary_sensor.tibber_is_in_best_3h_window', 'savings_percent') }}% Ersparnis)"

  - alias: "Pool - Pumpe stoppen"
    trigger:
      - platform: state
        entity_id: binary_sensor.tibber_is_in_best_3h_window
        to: "off"

    action:
      - service: switch.turn_off
        target:
          entity_id: switch.pool_pump

# ----------------------------------------------------------------------------
# Beispiel 4: Waschmaschine/Trockner Benachrichtigung
# ----------------------------------------------------------------------------
automation:
  - alias: "Haushalt - Beste Zeit fÃ¼r Waschmaschine"
    description: "Benachrichtigt wenn beste 3h-Fenster fÃ¼r Waschmaschine beginnt"

    trigger:
      - platform: state
        entity_id: binary_sensor.tibber_is_in_best_3h_window
        to: "on"

    condition:
      # Nur zwischen 6 Uhr und 22 Uhr
      - condition: time
        after: "06:00:00"
        before: "22:00:00"

    action:
      - service: notify.mobile_app
        data:
          title: "ðŸ’¡ GÃ¼nstige Strompreise jetzt!"
          message: >
            Die 3 gÃ¼nstigsten Stunden beginnen jetzt.
            Perfekt fÃ¼r: Waschmaschine, Trockner, GeschirrspÃ¼ler

            Zeitfenster: {{ state_attr('binary_sensor.tibber_is_in_best_3h_window', 'window_hours') }}
            Durchschnitt: {{ state_attr('binary_sensor.tibber_is_in_best_3h_window', 'window_average_price') }}â‚¬/kWh
            Ersparnis: {{ state_attr('binary_sensor.tibber_is_in_best_3h_window', 'savings_percent') }}%

# ----------------------------------------------------------------------------
# Beispiel 5: Smart Home Szene wÃ¤hrend gÃ¼nstigem Fenster
# ----------------------------------------------------------------------------
automation:
  - alias: "Smart Home - Energieintensive Szene"
    description: "Aktiviert energieintensive GerÃ¤te wÃ¤hrend billigstem Fenster"

    trigger:
      - platform: state
        entity_id: binary_sensor.tibber_is_in_best_3h_window
        to: "on"

    action:
      # Tesla laden
      - service: switch.turn_on
        target:
          entity_id: switch.tesla_charger

      # Warmwasser aufheizen
      - service: switch.turn_on
        target:
          entity_id: switch.water_heater_boost

      # Poolpumpe starten (wenn Sommer)
      - service: switch.turn_on
        target:
          entity_id: switch.pool_pump
        conditions:
          - condition: template
            value_template: "{{ now().month >= 5 and now().month <= 9 }}"

      # Klimaanlage vorkÃ¼hlen
      - service: climate.set_temperature
        target:
          entity_id: climate.living_room
        data:
          temperature: 20

      - service: notify.mobile_app
        data:
          title: "âš¡ Energieintensive Szene aktiviert"
          message: "Alle GerÃ¤te nutzen das gÃ¼nstigste 3h-Fenster"

  - alias: "Smart Home - Energieintensive Szene beenden"
    trigger:
      - platform: state
        entity_id: binary_sensor.tibber_is_in_best_3h_window
        to: "off"

    action:
      # Alle energieintensiven GerÃ¤te deaktivieren
      - service: switch.turn_off
        target:
          entity_id:
            - switch.tesla_charger
            - switch.water_heater_boost
            - switch.pool_pump

# ============================================================================
# VerfÃ¼gbare Sensor-Attribute
# ============================================================================
#
# Der Sensor binary_sensor.tibber_is_in_best_3h_window hat folgende Attribute:
#
# - window_start: Startzeit des Fensters (ISO Format)
# - window_end: Endzeit des Fensters (ISO Format)
# - window_average_price: Durchschnittspreis im Fenster (â‚¬/kWh)
# - daily_average_price: Tagesdurchschnitt (â‚¬/kWh)
# - savings_per_kwh: Ersparnis pro kWh vs. Durchschnitt (â‚¬)
# - savings_percent: Prozentuale Ersparnis (%)
# - window_hours: Liste der 3 Stunden mit Preisen
# - window_duration: "3 hours"
#
# Zugriff via Template:
# {{ state_attr('binary_sensor.tibber_is_in_best_3h_window', 'window_average_price') }}
# ============================================================================

# ============================================================================
# Tipps fÃ¼r optimale Nutzung
# ============================================================================
#
# 1. **Kombiniere mehrere GerÃ¤te**
#    Nutze das 3h-Fenster fÃ¼r ALLE energieintensiven GerÃ¤te gleichzeitig
#
# 2. **Priorisiere notwendige Lasten**
#    Tesla muss geladen werden? Nutze das Fenster dafÃ¼r
#
# 3. **Plane voraus**
#    Schaue morgens wann das beste Fenster ist und plane den Tag
#
# 4. **Nutze die Attribute**
#    Zeige die Ersparnis an um zu motivieren
#
# 5. **Teste die Automation**
#    Aktiviere zunÃ¤chst nur Benachrichtigungen, dann GerÃ¤te
# ============================================================================
