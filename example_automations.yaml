# Beispiel-Automatisierungen fÃ¼r Tibber Smart Control
# Kopiere diese in deine automations.yaml oder erstelle sie Ã¼ber die UI

# ============================================
# BATTERIE MANAGEMENT
# ============================================

# 1. BYD Batterie bei sehr gÃ¼nstigen Preisen laden
- alias: "BYD Battery - Laden bei VERY_CHEAP"
  description: "LÃ¤dt die BYD Batterie wenn Strom sehr gÃ¼nstig ist"
  trigger:
    - platform: state
      entity_id: binary_sensor.tibber_is_very_cheap
      to: "on"
  condition:
    # Nur laden wenn SOC unter 90%
    - condition: numeric_state
      entity_id: sensor.byd_soc
      below: 90
  action:
    # Hier Service zum Batterie laden einfÃ¼gen
    # Beispiel mit Kostal PLENTICORE:
    # - service: modbus.write_register
    #   data:
    #     hub: kostal
    #     address: 1034
    #     value: 1  # Battery charging aktivieren
    - service: notify.mobile_app
      data:
        title: "âš¡ BYD Batterie lÃ¤dt"
        message: >
          Strom ist sehr gÃ¼nstig: {{ states('sensor.tibber_current_price') }} EUR/kWh
          Batterie SOC: {{ states('sensor.byd_soc') }}%

# 2. BYD Batterie bei teuren Preisen entladen
- alias: "BYD Battery - Entladen bei EXPENSIVE"
  description: "Nutzt die BYD Batterie wenn Strom teuer ist"
  trigger:
    - platform: state
      entity_id: binary_sensor.tibber_is_expensive
      to: "on"
  condition:
    # Nur entladen wenn SOC Ã¼ber 30%
    - condition: numeric_state
      entity_id: sensor.byd_soc
      above: 30
  action:
    # Hier Service zum Batterie entladen einfÃ¼gen
    - service: notify.mobile_app
      data:
        title: "ðŸ”‹ BYD Batterie entlÃ¤dt"
        message: >
          Strom ist teuer: {{ states('sensor.tibber_current_price') }} EUR/kWh
          Batterie SOC: {{ states('sensor.byd_soc') }}%

# 3. Optimales Laden in den gÃ¼nstigsten Stunden
- alias: "BYD Battery - Smart Charging (Top 3 Stunden)"
  description: "LÃ¤dt gezielt in den 3 gÃ¼nstigsten Stunden des Tages"
  trigger:
    - platform: state
      entity_id: binary_sensor.tibber_is_cheapest_hour
      to: "on"
  condition:
    - condition: numeric_state
      entity_id: sensor.byd_soc
      below: 100
    # Nur laden wenn noch Platz ist
    - condition: template
      value_template: "{{ states('sensor.byd_soc') | float < 95 }}"
  action:
    # Maximales Laden aktivieren
    - service: notify.mobile_app
      data:
        title: "â­ Top gÃ¼nstige Stunde!"
        message: >
          Jetzt laden! Eine der 3 gÃ¼nstigsten Stunden heute.
          Preis: {{ states('sensor.tibber_current_price') }} EUR/kWh
          Durchschnitt: {{ states('sensor.tibber_average_price') }} EUR/kWh
          GÃ¼nstigste Stunden: {{ state_attr('binary_sensor.tibber_is_cheapest_hour', 'cheapest_hours') }}

# ============================================
# TESLA / EV CHARGING
# ============================================

# 4. Tesla bei guten Ladezeiten laden
- alias: "Tesla - Smart Charging"
  description: "Startet Tesla Laden bei gÃ¼nstigen Preisen"
  trigger:
    - platform: state
      entity_id: binary_sensor.tibber_is_good_charging_time
      to: "on"
  condition:
    # Nur laden wenn Tesla zuhause und unter 80%
    - condition: state
      entity_id: device_tracker.tesla
      state: "home"
    - condition: numeric_state
      entity_id: sensor.tesla_battery
      below: 80
  action:
    - service: switch.turn_on
      target:
        entity_id: switch.tesla_charger
    - service: notify.mobile_app
      data:
        title: "ðŸš— Tesla lÃ¤dt"
        message: >
          Gute Ladezeit erkannt!
          Preis: {{ states('sensor.tibber_current_price') }} EUR/kWh
          Level: {{ states('sensor.tibber_price_level') }}

# 5. Tesla Laden stoppen bei teuren Preisen
- alias: "Tesla - Stopp bei EXPENSIVE"
  description: "Stoppt Tesla Laden wenn Strom teuer wird"
  trigger:
    - platform: state
      entity_id: binary_sensor.tibber_is_expensive
      to: "on"
  condition:
    - condition: state
      entity_id: switch.tesla_charger
      state: "on"
  action:
    - service: switch.turn_off
      target:
        entity_id: switch.tesla_charger
    - service: notify.mobile_app
      data:
        title: "ðŸš— Tesla Laden pausiert"
        message: >
          Strom ist teuer: {{ states('sensor.tibber_current_price') }} EUR/kWh
          Batterie: {{ states('sensor.tesla_battery') }}%

# ============================================
# BENACHRICHTIGUNGEN
# ============================================

# 6. TÃ¤gliche Ãœbersicht der gÃ¼nstigsten Stunden
- alias: "Tibber - TÃ¤gliche PreisÃ¼bersicht"
  description: "Sendet morgens eine Ãœbersicht der gÃ¼nstigsten Stunden"
  trigger:
    - platform: time
      at: "08:00:00"
  action:
    - service: notify.mobile_app
      data:
        title: "âš¡ Tibber PreisÃ¼bersicht Heute"
        message: >
          Durchschnitt: {{ states('sensor.tibber_average_price') }} EUR/kWh
          Min: {{ states('sensor.tibber_min_price') }} EUR/kWh
          Max: {{ states('sensor.tibber_max_price') }} EUR/kWh

          GÃ¼nstigste Stunden:
          {{ states('sensor.tibber_cheapest_hours') }}

          Teuerste Stunden:
          {{ states('sensor.tibber_most_expensive_hours') }}

# 7. Warnung bei sehr hohen Preisen
- alias: "Tibber - Warnung sehr hohe Preise"
  description: "Warnt wenn Preise sehr hoch sind"
  trigger:
    - platform: state
      entity_id: binary_sensor.tibber_is_very_expensive
      to: "on"
  action:
    - service: notify.mobile_app
      data:
        title: "âš ï¸ Sehr hohe Strompreise!"
        message: >
          Aktuell: {{ states('sensor.tibber_current_price') }} EUR/kWh
          Das ist {{ ((states('sensor.tibber_current_price') | float / states('sensor.tibber_average_price') | float - 1) * 100) | round(0) }}% Ã¼ber dem Durchschnitt!

          Vermeide unnÃ¶tigen Verbrauch!

# ============================================
# ERWEITERTE AUTOMATISIERUNGEN
# ============================================

# 8. Intelligentes Energie-Management
- alias: "Smart Energy Management - Master"
  description: "Zentrale Steuerung aller Verbraucher basierend auf Preis"
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.tibber_is_very_cheap
        - binary_sensor.tibber_is_cheap
        - binary_sensor.tibber_is_expensive
        - binary_sensor.tibber_is_very_expensive
  action:
    - choose:
        # SEHR GÃœNSTIG - Alles an
        - conditions:
            - condition: state
              entity_id: binary_sensor.tibber_is_very_cheap
              state: "on"
          sequence:
            - service: switch.turn_on
              target:
                entity_id:
                  - switch.tesla_charger
                  - switch.heat_pump_boost
                  # - switch.warmwasserspeicher
            - service: notify.mobile_app
              data:
                message: "âš¡ SEHR GÃœNSTIG - Alle Verbraucher aktiviert"

        # GÃœNSTIG - Essentielles laden
        - conditions:
            - condition: state
              entity_id: binary_sensor.tibber_is_cheap
              state: "on"
          sequence:
            - service: switch.turn_on
              target:
                entity_id: switch.tesla_charger

        # TEUER - Batterie nutzen, Verbraucher reduzieren
        - conditions:
            - condition: state
              entity_id: binary_sensor.tibber_is_expensive
              state: "on"
          sequence:
            - service: switch.turn_off
              target:
                entity_id:
                  - switch.tesla_charger
                  - switch.heat_pump_boost

        # SEHR TEUER - Alles aus, nur Batterie
        - conditions:
            - condition: state
              entity_id: binary_sensor.tibber_is_very_expensive
              state: "on"
          sequence:
            - service: switch.turn_off
              target:
                entity_id:
                  - switch.tesla_charger
                  - switch.heat_pump_boost
            - service: notify.mobile_app
              data:
                message: "âš ï¸ SEHR TEUER - Nur Batteriebetrieb"

# 9. Preisbasierte Klimaanlagen-Steuerung
- alias: "Klimaanlage - Nur bei gÃ¼nstigen Preisen"
  description: "Erlaubt Klimaanlage nur wenn Strom gÃ¼nstig ist"
  trigger:
    - platform: state
      entity_id: climate.wohnzimmer
      to: "cool"
  condition:
    # Blockiert wenn Strom teuer ist
    - condition: state
      entity_id: binary_sensor.tibber_is_expensive
      state: "on"
  action:
    - service: climate.turn_off
      target:
        entity_id: climate.wohnzimmer
    - service: notify.mobile_app
      data:
        message: "â„ï¸ Klimaanlage deaktiviert - Strom ist zu teuer"

# 10. Nachtladen bei gÃ¼nstigen Nachtstrom
- alias: "BYD Battery - Nachtladen (gÃ¼nstig)"
  description: "LÃ¤dt BYD nachts nur wenn Preis gÃ¼nstig ist"
  trigger:
    - platform: time
      at: "02:00:00"
  condition:
    # Nur laden wenn gÃ¼nstig UND SOC niedrig
    - condition: or
      conditions:
        - condition: state
          entity_id: binary_sensor.tibber_is_cheap
          state: "on"
        - condition: state
          entity_id: binary_sensor.tibber_is_cheapest_hour
          state: "on"
    - condition: numeric_state
      entity_id: sensor.byd_soc
      below: 50
  action:
    # Nachtladen aktivieren
    - service: notify.mobile_app
      data:
        message: >
          ðŸŒ™ Nachtladen gestartet
          Preis: {{ states('sensor.tibber_current_price') }} EUR/kWh
          SOC: {{ states('sensor.byd_soc') }}%
